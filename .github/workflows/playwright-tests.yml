# GitHub Actions Workflow for WeSign Playwright Tests
# Systematic test execution with strong assertions methodology

name: WeSign E2E Tests

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_module:
        description: 'Test module to run (all, contacts, documents, templates, self-signing)'
        required: false
        default: 'all'

env:
  PYTHON_VERSION: '3.12'
  BASE_URL: 'https://devtest.comda.co.il'
  PLAYWRIGHT_VERSION: 'v1.40.0'

jobs:
  # ========================================
  # JOB: Setup and Lint
  # ========================================
  setup:
    name: Setup and Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r new_tests_for_wesign/requirements.txt
          pip install flake8 black pytest-html pytest-json-report

      - name: Lint Python code
        run: |
          flake8 new_tests_for_wesign/tests/ --max-line-length=120 --exclude=__pycache__ || true
          black --check new_tests_for_wesign/tests/ || true
        continue-on-error: true

  # ========================================
  # JOB: API Tests
  # ========================================
  api-tests:
    name: API Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      - name: Run API Tests
        run: |
          cd new_tests_for_wesign/api_tests
          mkdir -p ../reports/api

          for collection in *.postman_collection.json; do
            echo "Testing: $collection"
            newman run "$collection" \
              -e WeSign_Unified_Environment.postman_environment.json \
              -r cli,htmlextra \
              --reporter-htmlextra-export ../reports/api/${collection%.postman_collection.json}.html \
              || true
          done

      - name: Upload API Test Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: api-test-reports
          path: new_tests_for_wesign/reports/api/
          retention-days: 30

  # ========================================
  # JOB: E2E Tests - Contacts Module
  # ========================================
  e2e-contacts:
    name: E2E Tests - Contacts
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.inputs.test_module == 'all' || github.event.inputs.test_module == 'contacts' || github.event.inputs.test_module == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r new_tests_for_wesign/requirements.txt
          playwright install chromium --with-deps

      - name: Run Contacts Tests
        run: |
          cd new_tests_for_wesign
          pytest tests/contacts/ \
            -v \
            --maxfail=999 \
            --tb=short \
            --junit-xml=reports/junit/contacts.xml \
            --html=reports/html/contacts.html \
            --self-contained-html
        continue-on-error: true

      - name: Upload Test Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: contacts-test-reports
          path: |
            new_tests_for_wesign/reports/
            new_tests_for_wesign/screenshots/
            new_tests_for_wesign/videos/
            new_tests_for_wesign/traces/
          retention-days: 30

  # ========================================
  # JOB: E2E Tests - Documents Module
  # ========================================
  e2e-documents:
    name: E2E Tests - Documents
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.inputs.test_module == 'all' || github.event.inputs.test_module == 'documents' || github.event.inputs.test_module == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r new_tests_for_wesign/requirements.txt
          playwright install chromium --with-deps

      - name: Run Documents Tests
        run: |
          cd new_tests_for_wesign
          pytest tests/documents/ \
            -v \
            --maxfail=999 \
            --tb=short \
            --junit-xml=reports/junit/documents.xml \
            --html=reports/html/documents.html \
            --self-contained-html
        continue-on-error: true

      - name: Upload Test Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: documents-test-reports
          path: |
            new_tests_for_wesign/reports/
            new_tests_for_wesign/screenshots/
            new_tests_for_wesign/videos/
            new_tests_for_wesign/traces/
          retention-days: 30

  # ========================================
  # JOB: E2E Tests - Templates Module (STRONG Assertions)
  # ========================================
  e2e-templates:
    name: E2E Tests - Templates (Strong Assertions)
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.inputs.test_module == 'all' || github.event.inputs.test_module == 'templates' || github.event.inputs.test_module == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r new_tests_for_wesign/requirements.txt
          playwright install chromium --with-deps

      - name: Run Templates Tests (Real Validation)
        run: |
          cd new_tests_for_wesign
          pytest tests/templates/test_templates_real_validation.py \
            -v \
            --maxfail=999 \
            --tb=short \
            --junit-xml=reports/junit/templates.xml \
            --html=reports/html/templates.html \
            --self-contained-html
        continue-on-error: true

      - name: Upload Test Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: templates-test-reports
          path: |
            new_tests_for_wesign/reports/
            new_tests_for_wesign/screenshots/
            new_tests_for_wesign/videos/
            new_tests_for_wesign/traces/
          retention-days: 30

  # ========================================
  # JOB: E2E Tests - Self-Signing Module
  # ========================================
  e2e-self-signing:
    name: E2E Tests - Self-Signing
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.inputs.test_module == 'all' || github.event.inputs.test_module == 'self-signing' || github.event.inputs.test_module == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r new_tests_for_wesign/requirements.txt
          playwright install chromium --with-deps

      - name: Run Self-Signing Tests
        run: |
          cd new_tests_for_wesign
          pytest tests/self_signing/ \
            -v \
            --maxfail=999 \
            --tb=short \
            --junit-xml=reports/junit/self-signing.xml \
            --html=reports/html/self-signing.html \
            --self-contained-html
        continue-on-error: true

      - name: Upload Test Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: self-signing-test-reports
          path: |
            new_tests_for_wesign/reports/
            new_tests_for_wesign/screenshots/
            new_tests_for_wesign/videos/
            new_tests_for_wesign/traces/
          retention-days: 30

  # ========================================
  # JOB: Test Report Summary
  # ========================================
  test-report:
    name: Generate Test Summary
    runs-on: ubuntu-latest
    needs: [api-tests, e2e-contacts, e2e-documents, e2e-templates, e2e-self-signing]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate Summary Report
        run: |
          cat > TEST_SUMMARY.md << 'EOF'
          # WeSign Test Execution Summary

          **Workflow Run**: ${{ github.run_number }}
          **Branch**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}
          **Author**: ${{ github.actor }}
          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Test Results

          ### API Tests
          - Status: ${{ needs.api-tests.result }}
          - Reports: [Download Artifacts](../../actions/runs/${{ github.run_id }})

          ### E2E Tests - Contacts Module
          - Status: ${{ needs.e2e-contacts.result }}
          - Reports: [Download Artifacts](../../actions/runs/${{ github.run_id }})

          ### E2E Tests - Documents Module
          - Status: ${{ needs.e2e-documents.result }}
          - Reports: [Download Artifacts](../../actions/runs/${{ github.run_id }})

          ### E2E Tests - Templates Module (STRONG Assertions)
          - Status: ${{ needs.e2e-templates.result }}
          - Reports: [Download Artifacts](../../actions/runs/${{ github.run_id }})
          - **Note**: Uses systematic MCP discovery + strong assertion methodology

          ### E2E Tests - Self-Signing Module
          - Status: ${{ needs.e2e-self-signing.result }}
          - Reports: [Download Artifacts](../../actions/runs/${{ github.run_id }})

          ## Artifacts

          All test reports, screenshots, videos, and traces are available in the workflow artifacts.

          Download at: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF

      - name: Upload Summary
        uses: actions/upload-artifact@v3
        with:
          name: test-summary
          path: TEST_SUMMARY.md
          retention-days: 90
